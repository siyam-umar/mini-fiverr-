<h2 class="text-center mb-4">
  Chat with <%= @conversation.sender == current_user ? @conversation.receiver.email : @conversation.sender.email %>
</h2>

<%= turbo_stream_from @conversation %>

<div id="messages-list" class="chat-container mb-4">
  <%= render @messages, current_user_id: current_user.id %> <!-- ✅ Pass current_user_id -->
</div>

<%= render "messages/form", conversation: @conversation, message: Message.new %>

<script>
function scrollToBottom() {
  const container = document.getElementById("messages-list");
  if (container) { container.scrollTop = container.scrollHeight; }
}

document.addEventListener("turbo:load", scrollToBottom);
document.addEventListener("turbo:frame-load", scrollToBottom);

// ✅ Correct fix: use event.detail.newStream for turbo stream target
document.addEventListener("turbo:before-stream-render", (event) => {
  const target = event.detail.newStream.getAttribute("target");
  if (target === "messages-list") { scrollToBottom(); }
});
</script>

<style>
.chat-message { display: flex; margin-bottom: 12px; }
.chat-message.incoming { justify-content: flex-start; }
.chat-message.outgoing { justify-content: flex-end; }

.message-bubble {
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.4;
  box-shadow: 0px 1px 3px rgba(0,0,0,0.1);
  word-wrap: break-word;
}

.chat-message.outgoing .message-bubble {
  background-color: #dcf8c6; /* WhatsApp style */
  border-bottom-right-radius: 5px;
}

.chat-message.incoming .message-bubble {
  background-color: #ffffff;
  border-bottom-left-radius: 5px;
}

.message-text { font-size: 0.95rem; }
.timestamp { font-size: 11px; color: #888; margin-top: 5px; }

.chat-container {
  max-height: 450px;
  overflow-y: auto;
  padding: 15px;
  background-color: #f0f2f5;
  border-radius: 15px;
  border: 1px solid #ccc;
}

.text-danger:hover { text-decoration: underline; cursor: pointer; }
</style>
